name: Super Acci√≥n Demo

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  super-action:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Instalar dependencias del proyecto
        run: npm install

      - name: Ejecutar acci√≥n personalizada
        uses: ./.github/actions/super-action
        with:
          nombre: ${{ github.actor }}
          cena: "pizza barbacoa"

      - name: Push de cambios formateados
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}
          echo "Usando token GH_TOKEN para el push."

          # Verificamos si hay cambios
          if [ -n "$(git status --porcelain)" ]; then
            echo "üìÑ Hay cambios tras la acci√≥n personalizada, haciendo commit..."
            git add .
            git commit -m "üöÄ C√≥digo autoformateado por la acci√≥n [skip ci]" || echo "Sin cambios que commitear"

            # Pull con autostash para evitar el error
            git pull --rebase --autostash origin ${{ github.ref_name }} || echo "‚ö†Ô∏è No se pudo hacer rebase, puede que no fuera necesario"
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "‚úÖ No hay cambios que hacer push tras la acci√≥n personalizada."
          fi

      - name: Generar documentaci√≥n con JSDoc
        run: bash .github/actions/super-action/doc.sh

      - name: Verificar si docs_output cambi√≥ y hacer push si es necesario
        run: |
          echo "üìÇ Contenido de docs_output tras generar documentaci√≥n:"
          ls -R docs_output || echo "‚ùå La carpeta docs_output no fue creada"

          # A√±adir .gitkeep si no hay nada (solo la primera vez)
          if [ ! -d docs_output ]; then
            mkdir -p docs_output
            touch docs_output/.gitkeep
          fi

          if git diff --quiet docs_output; then
            echo "‚úÖ No hay cambios en docs_output, no se hace commit."
          else
            echo "üìÑ Hay cambios en documentaci√≥n, procediendo al commit..."
            git add docs_output
            git commit -m "üìö Documentaci√≥n generada autom√°ticamente [skip ci]" || echo "Sin cambios que commitear"
            git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}
            git pull --rebase origin ${{ github.ref_name }} || echo "No se pudo hacer rebase"
            git push origin HEAD:${{ github.ref_name }}
          fi
      - name: Actualizar README.md si hay nuevos contribuidores
        run: bash .github/actions/super-action/update_readme_if_new_contributor.sh 
